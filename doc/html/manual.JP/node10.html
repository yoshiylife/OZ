<!DOCTYPE HTML PUBLIC "-//W3O//DTD W3 HTML 2.0//EN">
<!Converted with LaTeX2HTML 95 (Thu Jan 19 1995) by Nikos Drakos (nikos@cbl.leeds.ac.uk), CBLU, University of Leeds >
<!Actually with its Japanized version JLaTeX2HTML 95 (Wed Mar 1 1995) by Masahiro Kitagawa (kitagawa@ee.es.osaka-u.ac.jp), Osaka University >
<HEAD>
<TITLE>2.6 アプリケーション・ゲートウェイの説明</TITLE>
</HEAD>
<BODY>
<meta name="description" value="2.6 アプリケーション・ゲートウェイの説明">
<meta name="keywords" value="main">
<meta name="resource-type" value="document">
<meta name="distribution" value="global">
<P>
 <H2><A NAME=SECTION00036000000000000000>2.6 アプリケーション・ゲートウェイの説明</A></H2>
<P>
<H3><A NAME=SECTION00036100000000000000>2.6.1 アプリケーションゲートウェイマニュアル</A></H3>
<P>
<DL ><DT>［名前］
<DD> <P>
ozag - OZ アプリケーションゲートウェイ
<DT>［形式］
<DD> <P>
ozag
<DT>［機能説明］
<DD> <P>
アプリケーションゲートウェイはゲートウェイマシン上で実行され、一つ以上
のサイトに対して次のサービスを行う。
<P>
<blockquote> <UL><LI> OZ++ サイト外部のエグゼキュータへのブロードキャストの中継。
<LI> OZ++ サイトサイト外部へ(から)のメソッドインボケーションやリター
ン値の中継、および外来パケットに対する外来フラグの付加。
<LI> OZ++ サイト外部へ(から)のクラスファイル転送パケットの中継。
</UL></blockquote>
<P>

<P>
<DT>［ファイル］
<DD> <P>
<UL><LI> $OZROOT/etc/SITE_table
アプリケーションゲートウェイが起動時に読み込むサイト表である。
<P>
起動時にファイルが無い場合には、WWWサーバからサイト表の内容が
自動的にロードされる。ファイルの最初の行にロードされたサイト表
の更新日時が記録される。
<P>
サイト表
は次の項目から構成される。
<UL><LI> サイト ID
<LI> サイト ID に相当するサイトのアプリケーションゲートウェイのホスト
名、もしくは IP アドレス
</UL>
<LI> $OZROOT/etc/apgw_LSiteInfo<BR> 
アプリケーションゲートウェイが起動時に読み込む局所サイト情報である。局
所サイト情報はアプリケーションゲートウェイが管理するサイトの情報を記述
する。アプリケーションゲートウェイが複数のサイトを管理する場合には、
局所サイト情報には複数サイトの情報が登録される。局所サイト情報は次の項
目から構成される。
<UL><LI> サイト ID
<LI> サイト ID に相当するリレーニュクリアスのホスト名、もしくは IP アドレス
<LI> サイト ID に相当するリレーニュクリアスのポート番号
<LI> サイト のタイプ(P[進歩的運用],C[保守的運用],I[一時的削除])
</UL></UL> 
 </DL><H3><A NAME=SECTION00036200000000000000>2.6.2 アプリケーションゲートウェイ
  の起動</A></H3>
<P>
アプリケーションゲートウェイ
  を起動するには、端末から UNIX コマンドとし
て起動する。
<P>
アプリケーションゲートウェイ
  は起動時にログファイルを作成し、そのファイル
名は端末に表示される。
<P>

<P>

<P>
<H3><A NAME=SECTION00036300000000000000>2.6.3 アプリケーションゲートウェイ
  の終了</A></H3>
<P>
  端末からexitコマンドの入力によって終了させる。
　また、端末から割り込み(SIGTERM)によって終了させることもできる。
<P>
<H3><A NAME=SECTION00036400000000000000>2.6.4 局所サイト
  情報の設定</A></H3>
<P>
アプリケーションゲートウェイ
  によるサイト間の中継の経路には次の二つが考えられる。
図はアドレス解決の中継手順を示している。
<blockquote> <UL><LI> 局所サイトのサイトとそれ以外のサイトとの中継(図 <A HREF="node10.html#fig1">2.6--1</A>)<BR> 
アプリケーションゲートウェイ
  が管理しているサイトと他のサイトの中継を行う。
<LI> 局所サイト内の中継(図 <A HREF="node10.html#fig2">2.6--2</A>)<BR> 
アプリケーションゲートウェイ
  が複数のサイトを管理していて、管理の範囲内の中継を行う。
</UL></blockquote>
<P>
<A NAME=fig1>　</A>
<P>
<CENTER>
<TABLE>
<TR>
<TD ALIGN=CENTER>
<IMG  ALIGN=BOTTOM ALT="TwoApgw.gif" SRC="figure/TwoApgw.gif">
</TD>
</TR>
<TR>
<TD ALIGN=CENTER>
 <TABLE BORDER=2 CELLSPACING=0 CELLPADDING=10>

 <TR>
 <TD><I>(1) Request</I></TD>
 <TD><I>(2) NN_PRIMARY</I></TD>
 <TD><I>(3) NN_PRIMARY</I></TD>
 <TD><I>(4) AR_AG_QUERY</I></TD>
 </TR>

 <TR>
 <TD><I>(5) AR_AG_QUERY</I></TD>
 <TD><I>(6) NN_PRIMARY</I></TD>
 <TD><I>(7) NN_REPLY</I></TD>
 <TD><I>(8) NN_REPLY</I></TD>
 </TR>

 <TR>
 <TD><I>(9) AR_AG_REPLY</I></TD>
 <TD><I>(10) AR_AG_REPLY</I></TD>
 <TD><I>(11) NN_REPLY</I></TD>
 <TD><I>(12) Response</I></TD>
 </TR>

 </TABLE>
</TD>
</TR>

<TR>

<CAPTION ALIGN=BOTTOM><STRONG>図 2.6--1:</STRONG> 局所サイトとその他のサイトの中
継<BR></CAPTION>

</TABLE>
</CENTER>

<P>
<A NAME=fig2>　</A>
<P>
<CENTER>
<TABLE>
<TR>
<TD ALIGN=CENTER>
<IMG  ALIGN=BOTTOM ALT="OneApgw.gif" SRC="figure/OneApgw.gif">
</TD>
</TR>
<TR>
<TD ALIGN=CENTER>
 <TABLE BORDER=2 CELLSPACING=0 CELLPADDING=10>

 <TR>
 <TD><I>(1) Request</I></TD>
 <TD><I>(2) NN_PRIMARY</I></TD>
 <TD><I>(3) NN_PRIMARY</I></TD>
 <TD><I>(4) AR_AG_QUERY</I></TD>
 </TR>

 <TR>
 <TD><I>(5) NN_PRIMARY</I></TD>
 <TD><I>(6) NN_REPLY</I></TD>
 <TD><I>(7) NN_REPLY</I></TD>
 <TD><I>(8) AR_AG_REPLY</I></TD>

 <TR>
 </TR>
 <TD><I>(9) NN_REPLY</I></TD>
 <TD><I>(10) Response</I></TD>
 <TD><BR></TD>
 <TD><BR></TD>
 </TR>
 </TABLE>
<TR>

</TD>
</TR>
<CAPTION ALIGN=BOTTOM><STRONG>図 2.6--2:</STRONG> 局所サイト内の中継<BR></CAPTIO
N>

</TABLE>
</CENTER>

<P>
局所サイト情報として登録するサイト ID はあらかじめサイト表に登録されてい
るサイトでなければならない。
<P>
局所サイト情報の設定はファイル中の一行に一つのサイトの情報を記述する。形
式は次のように記述する。
<PRE>    &lt;サイト ID&gt;:&lt;rncl IP-Address&gt;:&lt;rncl ポート&gt;:&lt;サイトタイプ&gt;
</PRE>
  サイトタイプは進歩的運用ポリシーのサイトと保守的ポリシーのサイトの２種類
がある。
<P>
  進歩的運用ポリシーのサイトのオブジェクトはサイト外からもアクセスされる
し、他のサイトのオブジェクトをアクセスする事もできる。
保守的運用ポリシーのサイトは他のサイトのオブジェクトをアクセスする事は
できるが、サイト外からアクセスされる事はできない。
<P>
  局所サイト情報の設定は、add,remove,changeの各コマンドを用いて変更できる
が、以下に示すように直接ファイルの内容を設定してもかまわない。
<P>
局所サイトとその他のサイトの場合の局所サイト情報の設定 <BR>
<P>
この場合局所サイト情報に次のように登録する。
<PRE>  Site-1 側の設定)
     Site-1:&lt;IP-Address of R-Ncl1&gt;:&lt;port of R-Ncl1&gt;:&lt;type of site&gt;
</PRE>
<PRE>  Site-2 側の設定)
     Site-2:&lt;IP-Address of R-Ncl2&gt;:&lt;port of R-Ncl2&gt;:&lt;type of site&gt;
</PRE>
<P>
例) サイト 1 側の局所サイト情報
<PRE>     % cat $OZROOT/etc/apgw_LSiteInfo
     0005:bunax3:3777:C
</PRE>
<P>
例) サイト 2 側の局所サイト情報
<PRE>     % cat $OZROOT/etc/apgw_LSiteInfo
     0001:bun13:3777:P
</PRE>
<P>
局所サイト内の場合の局所サイト情報の設定 <BR>
<P>
この場合局所サイト情報に次のように登録する。
<PRE>     Site-2:&lt;IP-Address of R-Ncl2&gt;:&lt;port of R-Ncl2&gt;:&lt;type of site&gt;
     Site-3:&lt;IP-Address of R-Ncl3&gt;:&lt;port of R-Ncl3&gt;:&lt;type of site&gt;
</PRE>
<P>
<PRE>  例)
     % cat $OZROOT/etc/apgw_LSiteInfo
     0005:bunax3:3777:P
     0001:192.31.202.11:3777:P
</PRE>
<P>
リレーニュクリアスの設定 <BR>
<P>
リレーニュークリアス
  はアプリケーションゲートウェイ
  と通信し、他のサイト
への要求の送信と他のサイトからの要求の受信を中継する。
<P>
リレーニュークリアス
  の設定はニュクリアス表にリレーニュークリアス
  と対応す
るアプリケーションゲートウェイ
  を記述する。
<PRE>    RELAYNCL:&lt;リレーニュクリアスの IP-Address&gt;:&lt;OZAG IP-Address&gt;
</PRE>
リレーニュークリアス
  として登録されているものは、アプリケーションゲートウェイ
  の局所サイト
  情報に登録されている
リレーニュークリアス
  とお互いに整合性が取れている必要がある。
<P>
例えば次のように記述する。
<PRE>  例) リレーニュクリアスを bun13, アプリケーションゲートウェイを bunax3 とする設定
     % cat $OZROOT/etc/apgw_LSiteInfo
     0005:bun13:3777:P
     % cat $OZROOT/etc/ncl-data/NCL_table
     RELAYNCL:bun13:bunax3
</PRE>
<P>
<H3><A NAME=SECTION00036500000000000000>2.6.5 サイト表</A></H3>
<P>
サイト表($OZROOT/etc/SITE_table)はアプリケーションゲートウェイ
  が起動
時に読み込むテキストファイルで次の項目から構成される。
<P>
<PRE>    &lt;サイト ID&gt;:&lt;アプリケーションゲートウェイのホスト名、または IP アドレス&gt;:

  例)
     % cat $OZROOT/etc/SITE_table
     #Sunday, 09-Feb-97 06:24:39 GMT
     0004:192.33.202.15:
     0005:bunax3:
     0006:bun17
     0007:192.31.202.11:
</PRE>
<P>
<H3><A NAME=SECTION00036600000000000000>2.6.6 アプリケーションゲートウェイ
  のコマンド</A></H3>
<P>
アプリケーションゲートウェイ
  は以下のコマンドを受け付ける。これらの
コマンドはサイト情報に関するもの、局所サイト情報に関するもの、その他の
３種に分けられる。
<P>
<PRE>      list
      update
      local
      add
      remove
      change
      help
      exit
</PRE>
<P>
サイト表に関するコマンド <BR>
<P>
<DL ><DT>list [site_id]
<DD>
<P>
 サイト表を表示する。site_idが与えられた場合にはそのサイトがあればその
情報を、無ければエラーメッセージを表示する。
<P>
  例:
<PRE>     list
     ========================================
     SITE : IP address of application gateway
     0010 : bunny
     0011 : bunny
     0012 : bunny
     0020 : bunfs
     ========================================

     list 0020
     Site = 0020 : Application gateway = bunfs

     list 0023
     No such site (0023)
</PRE>
<P>
<DT>update
<DD>  <BR>
<P>
WWWサーバにある原本からサイト表を得る事により更新する。
アプリケーションゲートウェイ上のサイト表よりWWWサーバの情報が新しいなら
それをロードし、そうでなければサイト表の内容は最新であるので変更しない。
<P>
updateコマンドによりサイト表が更新された場合にはログに記録される。
<P>
 </DL>
<P>
局所サイト情報関連コマンド <BR>
<P>
<A NAME=seclocalSiteInformationCommand>　</A>
<P>
<DL ><DT>local
<DD>  <BR>
<P>
局所サイト表を表示する。
<P>
<DT>add site_id RNCL_host RNCL_port policy
<DD>  <BR>
<P>
所サイトを加える、あるいは以前削除した局所サイトを復活させる。
&quot;policy&quot;は 'P' または 'C'.でなければならない。
<P>
'add'操作はログに記録される。
<P>
<DT>remove site_id
<DD>  <BR>
<P>
   局所サイトを削除する。サイトのIDは再利用されないので、削除は一時的
な不活性化である。復活させるにはaddコマンドを用いる。
<P>
'remove' 操作はログに記録される。
<P>
<DT>change site_id policy
<DD>  <BR>
<P>
局所サイトの管理ポリシーを変える。&quot;policy&quot;は 'P' または 'C'でなければ
ならない。
<P>
'change' 操作はログに記録される。
<P>
'list','change','remove' コマンドの使用例：
<P>
<PRE>     local
     ----------------------------------------
     SITE :       policy      : relay NCL
     0010 :   PROGRESSIVE     : bun15
     0011 :   PROGRESSIVE     : bun12
     0012 :   PROGRESSIVE     : bun16
     ----------------------------------------

     change 10 C
     Local site (0010) changed

     local  
     ----------------------------------------
     SITE :       policy      : relay NCL
     0010 :   CONSERVATIVE    : bun15
     0011 :   PROGRESSIVE     : bun12
     0012 :   PROGRESSIVE     : bun16
     ----------------------------------------

     remove 11
     Local site (0011) removed

     local
     ----------------------------------------
     SITE :       policy      : relay NCL
     0010 :   CONSERVATIVE    : bun15
     0011 : removed temporary : bun12
     0012 :   PROGRESSIVE     : bun16
     ----------------------------------------
</PRE>
<P>
対応するログ(ログファイルの該当部分)：
<P>
<PRE>     [Mon Feb 24 19:47:45 1997] Change local site (0010:C)
     [Mon Feb 24 19:48:00 1997] Remove local site (0011)
</PRE>
<P>
 </DL>
<P>
その他のコマンド <BR>
<P>
<DL ><DT>exit
<DD>  <BR>
<P>
 アプリケーションゲートウェイを終了する。
<P>
<DT>help 
<DD>  <BR>
<P>
以下のヘルプメッセージを表示する。
<P>
<PRE>     ** List of Commands **
       -- Site List -- 
     list [site_id]
        List site table. If site_id is specified, list that site only.

     update
        Update site table by getting from master data.

       -- Local Site --
     local
        List local sites.

     add site_id RNCL_host RNCL_port policy   Add a local site.

     remove site_id
        Remove a local site.

     change site_id policy
        Change policy of a local site. policy must be C or P.

       -- Miscellaneous --
     help 
        Print this help message.

     exit
        Terminate OZ++ application geteway.
</PRE>
<P>
 </DL><H3><A NAME=SECTION00036700000000000000>2.6.7 ログ</A></H3>
<P>
アプリケーション・ゲートウェイは次のようなイベントについて日時とともに
ログファイルに記録する。
ログファイル名は$OZROOT/etc/AGxxxxxxxx.logである。 (xxxxxxxxは起動の
日時を表す8桁の16進数)
<P>
<PRE>  起動と終了
  メソッド起動の中継の始めと終り
  ファイル転送の中継の始めと終り
  サイト情報や局所サイト情報の変更
</PRE>
<P>
起動と終了 <BR>
<P>
ログの最初と最後のメッセージは、アプリケーションゲートウェイの起動と
終了のメッセージである。
<P>
例:
<PRE>     [Wed Feb 19 23:52:24 1997] Application Gateway started!

     [Thu Feb 20 01:16:59 1997] Application gateway terminated!
</PRE>
<P>
メソッド起動の中継の始めと終り <BR>
<P>
メソッド起動の中継の始めと終りは記録され、始めのメッセージには
呼び出し側と呼び出され側のOID、メッセージID、クラスIDが記録される。
<P>
一つのメソッド起動の始めと終りのメッセージの間に他のメッセージが
現われる事があるが、対応するメッセージは同じメッセージIDを持つ
事で判る(以下の例では&quot;001100100b00000f&quot;がメッセージIDである)
<P>
例:
<PRE>     [Thu Feb 20 01:12:32 1997] exmessage:New invocation starts: 
     caller:0x001100100b000005 callee:0x00100010000001a9 
     class_id:0x0010001000000187 message_id:0x001100100b00000f
     [Thu Feb 20 01:12:32 1997] exmessage: invocation 001100100b00000f finished
</PRE>
<P>
ファイル転送の中継の始めと終り <BR>
<P>
ファイル転送の中継の始めと終りは記録され、その際に送信元のエグゼキュータID
とファイル転送プロセスOzFGWのプロセス番号が記録される。
<P>
一つのファイル転送の始めと終りのメッセージの間に他のメッセージが
現われる事があるが、対応するメッセージは同じプロセス番号を持つ
事で判る(以下の例では&quot;26335&quot;がプロセス番号である)
<P>
例:
<PRE>     [Thu Feb 20 01:11:58 1997] DeliverClass: source of file 0010001000000000 
     (process:26335)
     [Thu Feb 20 01:11:59 1997] OzFGW: file_transfer process 26335 finished(0)
</PRE>
<P>
サイト情報や局所サイト情報の変更 <BR>
<P>
サイト情報や局所サイト情報の変更は<A HREF="node10.html#seclocalSiteInformationCommand">2.6.6.2</A>で示したように記録される。
保守的ポリシーのサイトのオブジェクトへのメソッド起動は拒絶され、拒絶した事
が記録される。
<P>
以下の例は同じオブジェクトへの三度のメソッド起動のログだが、途中で呼び出される
オブジェクトのサイトが進歩的から保守的に変わり、また元の進歩的に変更されて
いる。
<P>
例:
<PRE>     [Thu Feb 20 01:12:33 1997] exmessage:New invocation starts: 
     caller:0x001100100b000005 callee:0x00100010000001a9 
     class_id:0x0010001000000187 message_id:0x001100100b000013
     [Thu Feb 20 01:12:33 1997] exmessage: invocation 001100100b000013 finished
     [Thu Feb 20 01:13:02 1997] Change local site (0010:C)
     [Thu Feb 20 01:13:09 1997] exmessage:Reject invocation to conservative 
     site!
     [Thu Feb 20 01:13:38 1997] Change local site (0010:P)
     [Thu Feb 20 01:13:42 1997] exmessage:New invocation starts: 
     caller:0x001100100b000005 callee:0x00100010000001a9 
     class_id:0x0010001000000187 message_id:0x001100100b000015
     [Thu Feb 20 01:13:42 1997] exmessage: invocation 001100100b000015 finished
</PRE>
<P>
<H3><A NAME=SECTION00036800000000000000>2.6.8 アプリケーションゲートウェイ
  のトラブルに関して</A></H3>
<P>
アプリケーションゲートウェイ
  が何らかの原因で起動できない場合が考えられる。それには次のような
原因が考えられる。
<blockquote> <DL ><DT>(1)
<DD> アプリケーションゲートウェイ
  起動に必要なファイルがオープンできない。<BR> 
アプリケーションゲートウェイ
  起動時に必要なファイルには次のようなものがある。
<UL><LI> $OZROOT/etc/SITE_table(サイト表)
<LI> $OZROOT/etc/apgw-LSiteInfo(局所サイト情報)
</UL>
この場合は原因として考えられるものは、次のものが挙げられる。
<UL><LI> 環境変数 OZROOT が正常に設定されていない。
<LI> $OZROOT 下のディレクトリ、ファイルのパーミッションが正常に設
定されていない。
<LI> サイト表($OZROOT/etc/SITE_table)の記述に誤りがある。
</UL>
<DT>(2)
<DD> アプリケーションゲートウェイ
  の使用するポートに bind できない。
次のようなメッセージが出力される。
<PRE>     init_apgw_port: bind: Address already in use
     init_apgw_port: Other APGW start up already ?
</PRE>
これには次の原因が考えられる。
<UL><LI> 起動しようとしているステーションにすでにアプリケーションゲートウェイ
  が起動済みである。
<LI> アプリケーションゲートウェイ
  以外の別のアプリケーションによって、
すでにポートが bind されている。
</UL>
<DT>(3)
<DD> 局所サイト
  情報の設定の誤り<BR> 
次のようなメッセージが出力される。
<PRE>     init_localsite_info: Can't found LocalSiteID(????) on site-table
</PRE>
この原因は局所サイト
  情報に登録したサイト ID がサイト表に登録されて
いないことである。
<P>
 </DL></blockquote>
<P>
<BR> <HR>
<P><ADDRESS>
Copyright 1994-1997 Information-technology Promotion Agency, Japan
</ADDRESS>
</BODY>
